<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniHost Dashboard</title>
    
    <!-- Library Penting -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        [v-cloak] { display: none !important; }
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; }
    </style>
</head>
<body>

    <!-- 1. VIEWER MODE (Script ini yang bikin Link GitHub jadi Website) -->
    <script>
        // Cek apakah ada parameter ?view=... di URL
        const params = new URLSearchParams(window.location.search);
        const viewPath = params.get('view');
        
        // KONFIGURASI DATABASE
        const SB_URL = 'https://wmhhrcgvnfjsgeideyut.supabase.co';
        const SB_BUCKET = 'hosting';

        if (viewPath) {
            // Tampilan Loading
            document.body.innerHTML = '<div style="height:100vh;display:flex;justify-content:center;align-items:center;background:#fff;color:#333"><h3><i class="fa-solid fa-spinner fa-spin"></i> Memuat Website...</h3></div>';

            const fileUrl = `${SB_URL}/storage/v1/object/public/${SB_BUCKET}/${viewPath}`;
            
            // Trik agar CSS/Gambar terbaca: Set Base URL ke folder Supabase
            const baseUrl = fileUrl.substring(0, fileUrl.lastIndexOf('/')) + '/';

            fetch(fileUrl).then(async r => {
                if (!r.ok) throw new Error("File tidak ditemukan (404)");
                const text = await r.text();
                
                // Masukkan tag <base> agar browser tahu lokasi CSS/JS
                let html = text;
                if(html.includes('<head>')) {
                    html = html.replace('<head>', `<head><base href="${baseUrl}">`);
                } else {
                    html = `<base href="${baseUrl}">` + html;
                }

                document.open();
                document.write(html);
                document.close();
            }).catch(e => {
                document.body.innerHTML = `<div style="text-align:center;padding:50px;color:red"><h3>Gagal Memuat</h3><p>${e.message}</p></div>`;
            });

            // Stop loading sisa halaman dashboard
            throw new Error("Viewer Mode Active"); 
        }
    </script>

    <!-- 2. DASHBOARD APLIKASI (VueJS) -->
    <div id="app" v-cloak class="container mx-auto p-4 max-w-2xl">
        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-xl mt-10">
            <h1 class="text-2xl font-bold mb-6 text-white flex items-center gap-2">
                <i class="fa-solid fa-cloud-arrow-up text-blue-500"></i> MiniHost Uploader
            </h1>
            
            <!-- Login Form (Sederhana) -->
            <div v-if="!user" class="space-y-4">
                <input v-model="email" type="email" placeholder="Email" class="w-full p-3 bg-gray-900 border border-gray-600 rounded text-white">
                <input v-model="password" type="password" placeholder="Password" class="w-full p-3 bg-gray-900 border border-gray-600 rounded text-white">
                <div class="flex gap-2">
                    <button @click="handleAuth(true)" class="flex-1 bg-blue-600 text-white p-3 rounded hover:bg-blue-500">Login</button>
                    <button @click="handleAuth(false)" class="flex-1 bg-green-600 text-white p-3 rounded hover:bg-green-500">Daftar</button>
                </div>
            </div>

            <!-- Upload & List Dashboard -->
            <div v-else>
                <div class="mb-6 bg-gray-900 p-4 rounded border border-gray-700">
                    <label class="block text-xs text-gray-400 mb-1">NAMA FOLDER (Slug)</label>
                    <input v-model="projectName" placeholder="contoh: website-ku" class="w-full p-2 bg-gray-800 border border-gray-600 rounded text-white mb-2" @input="sanitizeName">
                    
                    <label class="block text-xs text-gray-400 mb-1">PILIH FILE ZIP</label>
                    <input type="file" ref="zipInput" accept=".zip" class="w-full text-sm text-gray-400">
                    
                    <button @click="deployZip" :disabled="loading" class="w-full mt-4 bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded transition">
                        {{ loading ? 'Sedang Upload...' : 'ðŸš€ UPLOAD WEBSITE' }}
                    </button>
                </div>

                <h3 class="font-bold text-gray-400 text-sm mb-3">LIST WEBSITE SAYA</h3>
                <div v-for="dep in deployments" :key="dep.id" class="bg-gray-700/50 p-3 rounded mb-2 flex justify-between items-center border border-gray-600">
                    <div class="overflow-hidden">
                        <div class="font-bold text-white">{{ dep.site_name }}</div>
                        <!-- LINK GITHUB (VIEWER) -->
                        <a :href="getViewerLink(dep.site_name)" target="_blank" class="text-xs text-blue-400 hover:underline truncate block">
                            {{ getViewerLink(dep.site_name) }}
                        </a>
                    </div>
                    <button @click="deleteSite(dep)" class="text-red-400 hover:text-red-300 px-3"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtaGhyY2d2bmZqc2dlaWRleXV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMjgyOTEsImV4cCI6MjA4MDcwNDI5MX0.sCewtOfQWDNtWVjpn_aLxUcIWuaiwlSoeO07ORW5Znk';
        
        createApp({
            setup() {
                const user = ref(null);
                const email = ref(''), password = ref('');
                const projectName = ref('');
                const loading = ref(false);
                const deployments = ref([]);
                const zipInput = ref(null);
                
                let sb = window.supabase.createClient(SB_URL, SUPABASE_KEY);

                onMounted(async () => {
                    const { data } = await sb.auth.getSession();
                    if(data.session) { user.value = data.session.user; fetchList(); }
                });

                const handleAuth = async (isLogin) => {
                    const { data, error } = isLogin 
                        ? await sb.auth.signInWithPassword({ email: email.value, password: password.value })
                        : await sb.auth.signUp({ email: email.value, password: password.value });
                    if(!error && data.session) { user.value = data.session.user; fetchList(); }
                    else alert(error?.message || 'Cek email konfirmasi');
                };

                const deployZip = async () => {
                    if(!projectName.value || !zipInput.value.files[0]) return alert('Isi nama & pilih ZIP');
                    loading.value = true;
                    try {
                        const zip = new JSZip();
                        const contents = await zip.loadAsync(zipInput.value.files[0]);
                        const basePath = `${user.value.id}/${projectName.value}`;
                        
                        for(const filename of Object.keys(contents.files)) {
                            if(!contents.files[filename].dir) {
                                const content = await contents.files[filename].async('blob');
                                // Deteksi Mime Type Sederhana
                                let mime = 'text/plain';
                                if(filename.endsWith('.html')) mime = 'text/html';
                                else if(filename.endsWith('.css')) mime = 'text/css';
                                else if(filename.endsWith('.js')) mime = 'application/javascript';
                                else if(filename.endsWith('.png')) mime = 'image/png';
                                
                                await sb.storage.from(SB_BUCKET).upload(`${basePath}/${filename}`, content, { upsert:true, contentType: mime });
                            }
                        }
                        
                        await sb.from('deployments').upsert({ user_id: user.value.id, site_name: projectName.value, public_url: 'ok' }, { onConflict: 'site_name, user_id'});
                        alert('Berhasil!'); fetchList();
                    } catch(e) { alert(e.message); }
                    loading.value = false;
                };

                const fetchList = async () => {
                    const { data } = await sb.from('deployments').select('*').eq('user_id', user.value.id);
                    deployments.value = data || [];
                };

                const getViewerLink = (slug) => {
                    // Logic Link Github
                    const origin = window.location.origin + window.location.pathname;
                    return `${origin}?view=${user.value.id}/${slug}/index.html`;
                };
                
                const sanitizeName = () => projectName.value = projectName.value.replace(/[^a-z0-9-]/g, '').toLowerCase();

                return { user, email, password, handleAuth, projectName, zipInput, deployZip, deployments, loading, getViewerLink, sanitizeName, deleteSite: async (d) => { if(confirm('Hapus?')) { await sb.from('deployments').delete().eq('id', d.id); fetchList(); } } };
            }
        }).mount('#app');
    </script>
</body>
</html>

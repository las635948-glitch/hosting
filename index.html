<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniHost System</title>
    
    <!-- CSS & Helper -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        [v-cloak] { display: none !important; }
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; }
        .loading-view { height: 100vh; display: flex; justify-content: center; align-items: center; background: #fff; color: #333; }
    </style>
</head>
<body>

    <!-- 1. VIEW MODE (JIKA LINK ?VIEW= ADA) -->
    <!-- Bagian ini menangani rendering agar HTML TAMPIL, bukan jadi teks -->
    <script>
        // Cek URL apakah ada parameter ?view=...
        const params = new URLSearchParams(window.location.search);
        const viewPath = params.get('view');
        
        // KONFIGURASI SUPABASE (Sama seperti bawah)
        const SB_URL = 'https://wmhhrcgvnfjsgeideyut.supabase.co';
        const SB_BUCKET = 'hosting';

        if (viewPath) {
            // Hentikan loading Dashboard, kita masuk mode Viewer
            document.body.innerHTML = '<div class="loading-view"><h3>Sedang Memuat Website...</h3></div>';
            
            const fileUrl = `${SB_URL}/storage/v1/object/public/${SB_BUCKET}/${viewPath}`;

            // Ambil isi file HTML dari Supabase dan Tulis ulang halaman ini
            fetch(fileUrl)
                .then(response => {
                    if (!response.ok) throw new Error("File tidak ditemukan / Error");
                    return response.text();
                })
                .then(html => {
                    // MAGIC HAPPENS HERE: Paksa browser merender HTML
                    document.open();
                    document.write(html);
                    document.close();
                })
                .catch(err => {
                    document.body.innerHTML = `<div style="padding:20px; text-align:center; color:red;">
                        <h2>Gagal Memuat Website</h2>
                        <p>${err.message}</p>
                        <a href="/" style="color:blue">Kembali ke Dashboard</a>
                    </div>`;
                });
                
            // Stop eksekusi script dashboard di bawah
            throw new Error("Mode Viewer Aktif - Stop Dashboard"); 
        }
    </script>

    <!-- 2. DASHBOARD MODE (JIKA BUKA HALAMAN UTAMA) -->
    <div id="app" v-cloak class="container mx-auto p-4 max-w-xl pb-20">
        
        <div class="flex justify-between items-center mb-8 mt-4">
            <h1 class="text-2xl font-bold text-white">ðŸš€ MiniHost <span class="text-xs bg-blue-600 px-2 rounded">Viewer Mode</span></h1>
            <button v-if="user" @click="logout" class="text-red-400 text-sm border border-red-900 bg-red-900/20 px-3 py-1 rounded">Logout</button>
        </div>

        <div v-if="!user">
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h2 class="text-xl font-bold mb-4 text-white text-center">{{ isLoginMode ? 'Login' : 'Daftar' }}</h2>
                <form @submit.prevent="handleAuth" class="space-y-4">
                    <input v-model="email" type="email" required class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded" placeholder="Email">
                    <input v-model="password" type="password" required class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded" placeholder="Password">
                    <button type="submit" :disabled="loading" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded">
                        {{ loading ? 'Loading...' : (isLoginMode ? 'Masuk' : 'Daftar') }}
                    </button>
                </form>
                <p class="text-center mt-4 text-gray-400 text-sm cursor-pointer" @click="isLoginMode = !isLoginMode">
                    {{ isLoginMode ? 'Belum punya akun? Daftar' : 'Sudah punya akun? Login' }}
                </p>
                <p v-if="errorMsg" class="text-red-400 text-center mt-2 text-sm">{{ errorMsg }}</p>
            </div>
        </div>

        <div v-else>
            <div class="bg-gray-800 p-5 rounded-xl border border-gray-700 mb-8">
                <h3 class="font-bold text-lg mb-4 text-white">ðŸ“¤ Upload HTML / ZIP</h3>
                
                <div class="mb-4">
                    <label class="text-xs text-gray-500 uppercase block mb-1">Nama Project (Slug)</label>
                    <input v-model="projectName" type="text" placeholder="web-saya" class="w-full bg-gray-700 border border-gray-600 text-white p-2 rounded" @input="sanitizeProjectName">
                </div>

                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button @click="uploadType='single'" :class="uploadType=='single'?'bg-blue-600':'bg-gray-700'" class="p-2 rounded text-sm text-white">Single HTML</button>
                    <button @click="uploadType='zip'" :class="uploadType=='zip'?'bg-blue-600':'bg-gray-700'" class="p-2 rounded text-sm text-white">ZIP File</button>
                </div>

                <div v-if="uploadType === 'single'" class="mb-4 border-2 border-dashed border-gray-600 p-6 text-center rounded">
                    <input type="file" ref="htmlInput" accept=".html" @change="handleFile" class="text-white text-sm">
                </div>
                <div v-if="uploadType === 'zip'" class="mb-4 border-2 border-dashed border-gray-600 p-6 text-center rounded">
                    <input type="file" ref="zipInput" accept=".zip" @change="handleFile" class="text-white text-sm">
                </div>

                <button @click="deploy" :disabled="loading || !projectName" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded">
                    {{ loading ? 'Sedang Deploy...' : 'ðŸš€ DEPLOY' }}
                </button>
                <p v-if="statusMsg" class="text-center text-xs mt-2 text-blue-300">{{ statusMsg }}</p>
            </div>

            <!-- LIST WEBSITE (LINK SUDAH FIX ?VIEW=) -->
            <div>
                <h3 class="font-bold text-gray-400 text-sm mb-2 uppercase">Web Anda</h3>
                <div v-for="dep in deployments" :key="dep.id" class="bg-gray-800 p-4 rounded border border-gray-700 mb-2 flex justify-between items-center">
                    <div class="overflow-hidden mr-2">
                        <p class="font-bold text-white text-sm truncate">{{ dep.site_name }}</p>
                        <p class="text-xs text-gray-500">{{ new Date(dep.created_at).toLocaleDateString() }}</p>
                    </div>
                    <!-- LINK INI YANG PENTING: MENGARAH KE VIEWER -->
                    <a :href="getViewerLink(dep.site_name)" target="_blank" class="bg-blue-600 text-white px-3 py-1 rounded text-xs">
                        Buka Web
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtaGhyY2d2bmZqc2dlaWRleXV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMjgyOTEsImV4cCI6MjA4MDcwNDI5MX0.sCewtOfQWDNtWVjpn_aLxUcIWuaiwlSoeO07ORW5Znk';
        
        let sbClient = null;
        if(window.supabase) sbClient = window.supabase.createClient(SB_URL, SUPABASE_KEY);

        createApp({
            setup() {
                const user = ref(null);
                const email = ref(''); const password = ref('');
                const isLoginMode = ref(true); const loading = ref(false);
                const errorMsg = ref(''); const statusMsg = ref('');
                const projectName = ref(''); const uploadType = ref('single');
                const htmlInput = ref(null); const zipInput = ref(null);
                const deployments = ref([]);

                onMounted(async () => {
                    if(!sbClient) return;
                    const { data: { session } } = await sbClient.auth.getSession();
                    if(session) { user.value = session.user; fetchDeployments(); }
                    sbClient.auth.onAuthStateChange((_e, s) => { user.value = s?.user || null; if(user.value) fetchDeployments(); });
                });

                const handleAuth = async () => {
                    loading.value = true; errorMsg.value = '';
                    try {
                        const { data, error } = isLoginMode.value 
                            ? await sbClient.auth.signInWithPassword({ email: email.value, password: password.value })
                            : await sbClient.auth.signUp({ email: email.value, password: password.value });
                        if(error) throw error;
                        if(!isLoginMode.value && data.session) user.value = data.session.user;
                        else if(!isLoginMode.value) { isLoginMode.value=true; alert('Cek email konfirmasi!'); }
                    } catch(e) { errorMsg.value = e.message; }
                    finally { loading.value = false; }
                };

                const deploy = async () => {
                    if(!projectName.value) return;
                    loading.value = true; statusMsg.value = 'Memulai...';
                    const userId = user.value.id;
                    const basePath = `${userId}/${projectName.value}`;
                    
                    try {
                        if(uploadType.value === 'single') {
                            const file = htmlInput.value.files[0];
                            if(!file) throw new Error("Pilih HTML");
                            statusMsg.value = 'Upload HTML...';
                            await uploadFile(basePath, 'index.html', file, 'text/html');
                        } else {
                            const file = zipInput.value.files[0];
                            if(!file) throw new Error("Pilih ZIP");
                            statusMsg.value = 'Extract ZIP...';
                            const zip = new JSZip();
                            const contents = await zip.loadAsync(file);
                            for(const f of Object.keys(contents.files)) {
                                if(!contents.files[f].dir) {
                                    const blob = await contents.files[f].async('blob');
                                    let type = f.endsWith('.html') ? 'text/html' : 'auto';
                                    await uploadFile(basePath, f, type);
                                }
                            }
                        }

                        // Simpan Path Project (Bukan URL Langsung)
                        await sbClient.from('deployments').insert([{
                            user_id: userId, site_name: projectName.value, 
                            public_url: `${userId}/${projectName.value}/index.html` // Simpan path saja
                        }]);

                        alert('âœ… Berhasil!');
                        fetchDeployments();
                        projectName.value = '';
                    } catch(e) { 
                        if(e.code === '23505') { fetchDeployments(); alert('âœ… Update Berhasil'); }
                        else alert(e.message); 
                    } finally { loading.value = false; statusMsg.value = ''; }
                };

                const uploadFile = async (path, name, file, type) => {
                    await sbClient.storage.from(SB_BUCKET).upload(`${path}/${name}`, file, { upsert: true, contentType: type });
                };

                const fetchDeployments = async () => {
                    const { data } = await sbClient.from('deployments').select('*').eq('user_id', user.value.id).order('created_at', {ascending:false});
                    deployments.value = data || [];
                };

                // GENERATOR LINK ?VIEW=
                const getViewerLink = (siteName) => {
                    // Mendapatkan URL saat ini (misal: domain.github.io)
                    const currentHost = window.location.origin + window.location.pathname;
                    const path = `${user.value.id}/${siteName}/index.html`;
                    return `${currentHost}?view=${path}`;
                };

                return {
                    user, email, password, isLoginMode, handleAuth, loading, errorMsg, statusMsg,
                    projectName, uploadType, htmlInput, zipInput, deploy, deployments, getViewerLink,
                    sanitizeProjectName: () => projectName.value = projectName.value.replace(/[^a-z0-9-]/g, '').toLowerCase()
                };
            }
        }).mount('#app');
    </script>
</body>
</html>

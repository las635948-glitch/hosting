<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini Hosting Supabase</title>
    
    <!-- CSS: Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        [v-cloak] { display: none !important; }
        .loading-screen { display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif; }
    </style>

    <!-- LIBRARY -->
    <!-- 1. Vue.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <!-- 2. Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 3. JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="loading" class="loading-screen text-gray-500">
        <p>Memuat Aplikasi...</p>
    </div>

    <div id="app" v-cloak class="container mx-auto p-4 max-w-xl pb-20">
        
        <!-- HEADER -->
        <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <h1 class="text-2xl font-bold text-indigo-600">üöÄ MiniHost</h1>
            <button v-if="user" @click="logout" class="bg-red-50 text-red-600 px-3 py-1 rounded-lg text-sm font-medium border border-red-100">
                Logout
            </button>
        </div>

        <!-- ALERT BOX -->
        <div v-if="errorMsg" class="bg-red-50 text-red-600 p-3 rounded-lg mb-4 text-sm border border-red-200 text-center">
            {{ errorMsg }}
        </div>

        <!-- LOGIN / REGISTER -->
        <div v-if="!user">
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-xl font-bold mb-2 text-center">{{ isLoginMode ? 'Login Akun' : 'Daftar Baru' }}</h2>
                <p class="text-center text-gray-400 text-xs mb-6">Supabase Storage Hosting</p>

                <form @submit.prevent="handleAuth" class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Email</label>
                        <input v-model="email" type="email" required class="w-full mt-1 border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Password</label>
                        <input v-model="password" type="password" required class="w-full mt-1 border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <button type="submit" :disabled="loading" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition disabled:opacity-50">
                        {{ loading ? 'Memproses...' : (isLoginMode ? 'Masuk' : 'Daftar') }}
                    </button>
                </form>

                <p class="text-center mt-4 text-sm text-gray-600 cursor-pointer" @click="isLoginMode = !isLoginMode">
                    {{ isLoginMode ? 'Belum punya akun? Daftar' : 'Sudah punya akun? Login' }}
                </p>
            </div>
        </div>

        <!-- DASHBOARD -->
        <div v-else>
            <div class="bg-white p-5 rounded-xl shadow-md border border-gray-100 mb-6">
                <h3 class="font-bold text-lg mb-4">üì§ Upload Website</h3>
                
                <div class="mb-4">
                    <label class="text-xs font-bold text-gray-500 uppercase">Nama Project (Slug)</label>
                    <input v-model="projectName" type="text" placeholder="contoh: portofolio-ku" class="w-full mt-1 border p-2 rounded-lg bg-gray-50 text-sm" @input="sanitizeProjectName">
                </div>

                <div class="flex gap-2 mb-4 bg-gray-100 p-1 rounded-lg">
                    <button @click="uploadType = 'zip'" :class="uploadType === 'zip' ? 'bg-white shadow text-indigo-600' : 'text-gray-500'" class="flex-1 py-1.5 text-sm rounded-md font-medium transition">ZIP File</button>
                    <button @click="uploadType = 'raw'" :class="uploadType === 'raw' ? 'bg-white shadow text-indigo-600' : 'text-gray-500'" class="flex-1 py-1.5 text-sm rounded-md font-medium transition">Raw HTML</button>
                </div>

                <div v-if="uploadType === 'zip'" class="mb-4">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50">
                        <input type="file" ref="fileInput" accept=".zip" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    </div>
                    <p class="text-xs text-gray-400 mt-2 text-center">Upload file .zip (harus ada index.html)</p>
                </div>

                <div v-if="uploadType === 'raw'" class="mb-4">
                    <textarea v-model="rawHtml" rows="5" class="w-full border p-2 rounded-lg font-mono text-xs bg-gray-900 text-green-400" placeholder="<html>...</html>"></textarea>
                </div>

                <button @click="deploy" :disabled="loading || !projectName" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition disabled:opacity-50 flex justify-center items-center gap-2">
                    <span v-if="loading">‚è≥</span>
                    {{ loading ? 'Sedang Deploy...' : 'üöÄ Deploy Sekarang' }}
                </button>
                
                <div v-if="statusMsg" class="mt-3 text-xs text-center font-mono text-blue-600 bg-blue-50 p-2 rounded">
                    {{ statusMsg }}
                </div>
            </div>

            <div class="space-y-3">
                <h3 class="font-bold text-gray-700 px-1">üåê Website Anda</h3>
                <div v-if="deployments.length === 0" class="text-center py-10 bg-white rounded-xl border border-dashed border-gray-300 text-gray-400 text-sm">
                    Belum ada website.
                </div>
                
                <div v-for="dep in deployments" :key="dep.id" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                    <div class="overflow-hidden mr-3">
                        <p class="font-bold text-gray-800 text-sm truncate">{{ dep.site_name }}</p>
                        <a :href="dep.public_url" target="_blank" class="text-xs text-indigo-500 hover:underline truncate block">Link Website ‚Üó</a>
                    </div>
                    <a :href="dep.public_url" target="_blank" class="bg-gray-100 text-gray-600 px-3 py-2 rounded-lg text-xs font-bold border hover:bg-gray-200">
                        Buka
                    </a>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        // --- SETUP SUPABASE ---
        const SUPABASE_URL = 'https://wmhhrcgvnfjsgeideyut.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtaGhyY2d2bmZqc2dlaWRleXV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMjgyOTEsImV4cCI6MjA4MDcwNDI5MX0.sCewtOfQWDNtWVjpn_aLxUcIWuaiwlSoeO07ORW5Znk';
        const BUCKET_NAME = 'hosting';

        // PERBAIKAN: Menggunakan nama variabel berbeda 'sbClient' agar tidak bentrok
        // dengan variabel global 'supabase' dari library CDN.
        let sbClient = null;

        try {
            // Kita panggil window.supabase untuk memastikan kita pakai library yang benar
            if (window.supabase) {
                sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            } else {
                alert("Library Supabase gagal dimuat. Refresh halaman.");
            }
        } catch (err) {
            console.error(err);
        }

        const app = createApp({
            setup() {
                const user = ref(null);
                const email = ref('');
                const password = ref('');
                const isLoginMode = ref(true);
                const loading = ref(false);
                const errorMsg = ref('');
                const statusMsg = ref('');
                
                const projectName = ref('');
                const uploadType = ref('zip');
                const rawHtml = ref('<!DOCTYPE html>\n<html>\n<head><title>My Site</title></head>\n<body>\n  <h1>Hello World!</h1>\n</body>\n</html>');
                const fileInput = ref(null);
                const deployments = ref([]);

                const sanitizeProjectName = () => {
                    projectName.value = projectName.value.replace(/[^a-z0-9-]/g, '').toLowerCase();
                };

                onMounted(async () => {
                    document.getElementById('loading').style.display = 'none';
                    if (!sbClient) return; // Stop jika supabase error

                    // Menggunakan sbClient (bukan supabase)
                    const { data: { session } } = await sbClient.auth.getSession();
                    if (session) {
                        user.value = session.user;
                        fetchDeployments();
                    }
                    
                    sbClient.auth.onAuthStateChange((_event, session) => {
                        user.value = session ? session.user : null;
                        if(user.value) fetchDeployments();
                        else deployments.value = [];
                    });
                });

                const handleAuth = async () => {
                    if (!sbClient) return;
                    loading.value = true;
                    errorMsg.value = '';
                    try {
                        let result;
                        if (isLoginMode.value) {
                            result = await sbClient.auth.signInWithPassword({ email: email.value, password: password.value });
                        } else {
                            result = await sbClient.auth.signUp({ email: email.value, password: password.value });
                        }
                        
                        if (result.error) throw result.error;
                        
                        if (!isLoginMode.value && !result.data.session) {
                            alert('Pendaftaran berhasil! Silakan login (atau cek email jika konfirmasi aktif).');
                            isLoginMode.value = true;
                        }
                    } catch (e) {
                        errorMsg.value = e.message;
                    } finally {
                        loading.value = false;
                    }
                };

                const logout = async () => {
                    await sbClient.auth.signOut();
                };

                const deploy = async () => {
                    if(!projectName.value) return;
                    loading.value = true;
                    statusMsg.value = 'Memulai proses...';
                    
                    const userId = user.value.id;
                    const basePath = `${userId}/${projectName.value}`; 
                    
                    try {
                        if (uploadType.value === 'raw') {
                            statusMsg.value = 'Upload index.html...';
                            const blob = new Blob([rawHtml.value], { type: 'text/html' });
                            await uploadFile(basePath, 'index.html', blob, 'text/html');
                        } else if (uploadType.value === 'zip') {
                            const file = fileInput.value.files[0];
                            if (!file) throw new Error("Pilih file ZIP dulu!");

                            statusMsg.value = 'Ekstrak ZIP...';
                            const zip = new JSZip();
                            const contents = await zip.loadAsync(file);
                            
                            const keys = Object.keys(contents.files);
                            let i = 0;
                            for (const filename of keys) {
                                const fileData = contents.files[filename];
                                if (!fileData.dir) {
                                    i++;
                                    statusMsg.value = `Upload ${i}/${keys.length}: ${filename}`;
                                    const blob = await fileData.async('blob');
                                    
                                    let type = 'application/octet-stream';
                                    if(filename.endsWith('.html')) type = 'text/html';
                                    else if(filename.endsWith('.css')) type = 'text/css';
                                    else if(filename.endsWith('.js')) type = 'application/javascript';
                                    else if(filename.endsWith('.png')) type = 'image/png';
                                    else if(filename.endsWith('.jpg')) type = 'image/jpeg';

                                    await uploadFile(basePath, filename, blob, type);
                                }
                            }
                        }

                        statusMsg.value = 'Simpan Database...';
                        const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET_NAME}/${basePath}/index.html`;
                        
                        const { error: dbError } = await sbClient
                            .from('deployments')
                            .insert([{
                                user_id: userId,
                                site_name: projectName.value,
                                public_url: publicUrl
                            }]);

                        if(dbError && !dbError.message.includes('duplicate')) throw dbError;

                        alert('‚úÖ Berhasil Deploy!');
                        fetchDeployments();
                        statusMsg.value = '';
                        projectName.value = '';
                        if(fileInput.value) fileInput.value.value = null;

                    } catch (e) {
                        console.error(e);
                        errorMsg.value = 'Gagal: ' + e.message;
                        statusMsg.value = 'Error.';
                    } finally {
                        loading.value = false;
                    }
                };

                const uploadFile = async (basePath, filename, fileBody, contentType) => {
                    const { error } = await sbClient.storage
                        .from(BUCKET_NAME)
                        .upload(`${basePath}/${filename}`, fileBody, {
                            cacheControl: '3600',
                            upsert: true,
                            contentType: contentType
                        });
                    if (error) throw error;
                };

                const fetchDeployments = async () => {
                    const { data, error } = await sbClient
                        .from('deployments')
                        .select('*')
                        .eq('user_id', user.value.id)
                        .order('created_at', { ascending: false });
                    
                    if(data) deployments.value = data;
                };

                return {
                    user, email, password, isLoginMode, handleAuth, logout, loading, errorMsg,
                    projectName, sanitizeProjectName, uploadType, rawHtml, fileInput, deploy, statusMsg, deployments
                };
            }
        });

        app.mount('#app');
    </script>
</body>
</html>
